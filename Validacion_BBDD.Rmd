---
title: "Validation_DB"
author: "xxx"
output: html_document
---


```{r setup, include=FALSE}
# --- Instalar y cargar paquetes ---
if (!require("BiocManager", quietly = TRUE)) install.packages("BiocManager")
BiocManager::install(version = "3.20", ask = FALSE)
BiocManager::install(c("GEOquery", "org.Hs.eg.db"), ask = FALSE)

library(GEOquery)
library(dplyr)
library(tidyr)
library(tibble)
library(readr)
library(org.Hs.eg.db)
library(limma)
library(ggplot2)
library(ggpubr)
library(gridExtra)
library(RColorBrewer)

# GSE91061 FPKM
gse91061_file <- "Datos_finales/GSE91061_BMS038109Sample.hg19KnownGene.fpkm.csv.gz"
gse91061 <- read.csv(gse91061_file, row.names = 1)

# GSE196434 raw counts
gse196434_file <- "Datos_finales/GSE196434_MR_GEO_rawdata.txt.gz"
gse196434 <- read.delim(gse196434_file, row.names = 1)

# Crear carpeta de resultados si no existe
if(!dir.exists("Resultados")) dir.create("Resultados")

```

```{r limma GSE91061}
# Suponiendo que ya tienes un dataframe de diseño `design` con la variable `group`
# Esto es solo un ejemplo
design <- model.matrix(~ 0 + factor(rep(c("PR","NR"), each=ncol(gse91061)/2)))
colnames(design) <- c("PR","NR")

fit <- lmFit(as.matrix(gse91061), design)
contrast.matrix <- makeContrasts(PRvsNR = PR - NR, levels=design)
fit2 <- contrasts.fit(fit, contrast.matrix)
fit2 <- eBayes(fit2)

final_results <- topTable(fit2, number=Inf, adjust.method = "BH") %>%
  rownames_to_column(var="gene_clean") %>%
  mutate(contrast="PR_vs_NR")
```

```{r DESeq GSE196434}
# Suponiendo que tienes un dataframe de metadatos `pheno` con columnas `Sample` y `response`
dds <- DESeqDataSetFromMatrix(countData = gse196434,
                              colData = pheno,
                              design = ~ response)

dds <- DESeq(dds)
res <- results(dds, alpha=0.05)
res_df <- as.data.frame(res) %>%
  rownames_to_column(var="gene_clean") %>%
  mutate(contrast="LR_vs_SR")
```

```{r selección de genes significativos}
all_results <- bind_rows(final_results, res_df)

significant_genes <- all_results %>%
  filter(P.Value < 0.05 & abs(logFC) > log2(1.5)) %>%
  select(contrast, gene_clean, logFC, P.Value, padj) %>%
  arrange(contrast, desc(abs(logFC))) %>%
  rename(Gene=gene_clean, `Log2 Fold Change`=logFC,
         `P-value`=P.Value, `Adjusted P-value`=padj)

write_csv(significant_genes, "Resultados/genes_significativos.csv")
```

```{gráficos}
## 1. Volcano
ggplot(significant_genes, aes(x=`Log2 Fold Change`, y=-log10(`P-value`))) +
  geom_point(alpha=0.5) +
  theme_minimal() +
  xlab("Log2 Fold Change") +
  ylab("-log10(P-value)") +
  ggtitle("Volcano plot de genes significativos")
ggsave("Resultados/volcano_plot.png", width=6, height=4)

## 2. Heatmap
top_genes <- significant_genes %>% group_by(contrast) %>% slice_max(order_by=abs(`Log2 Fold Change`), n=20) %>% pull(Gene)
expr_matrix <- as.matrix(gse91061[top_genes,])
pheatmap(expr_matrix, filename="Resultados/heatmap_top_genes.png", scale="row",
         cluster_rows=TRUE, cluster_cols=TRUE, show_rownames=TRUE, show_colnames=FALSE)


## 3. PCA
expr_scaled <- t(scale(t(expr_matrix)))
pca <- prcomp(t(expr_scaled))
pca_df <- data.frame(PC1=pca$x[,1], PC2=pca$x[,2], Sample=colnames(expr_scaled))
ggplot(pca_df, aes(x=PC1, y=PC2, label=Sample)) +
  geom_point() +
  geom_text(vjust=-0.5, size=3) +
  theme_minimal() +
  ggtitle("PCA de genes top")
ggsave("Resultados/pca_top_genes.png", width=6, height=4)


```



```{r comp expr ITH}
```{r comp expr ITH}
# --- Cargar datos Nanostring ---
db_completa_log2 <- read_csv("Datos_finales/db_completa_log2.csv")
db_completa_log2 <- as.data.frame(db_completa_log2)

# Matriz expresión genes x muestras
expression_matrix <- db_completa_log2 %>%
  dplyr::select(ID, starts_with("Endogenous_")) %>%
  column_to_rownames("ID") %>%
  t() %>%
  as.matrix()

# Eliminar muestra GEM12 si existe
if ("GEM12" %in% colnames(expression_matrix)) {
  expression_matrix <- expression_matrix[, !colnames(expression_matrix) %in% "GEM12"]
}

# Metadata muestras
metadata <- db_completa_log2 %>%
  dplyr::select(ID, grupo, clinical_benefit, sexo, edad_diagnostico) %>%
  filter(ID %in% colnames(expression_matrix)) %>%
  mutate(
    grupo = factor(grupo, levels = c("BRAF_MEK", "ITH")),
    clinical_benefit = factor(clinical_benefit, levels = c("low", "high"))
  ) %>%
  column_to_rownames("ID")

# Crear variable respuesta combinada
db_completa_log2 <- db_completa_log2 %>%
  mutate(
    respuesta = case_when(
      grupo == "ITH" & clinical_benefit == "high" ~ "ITH_high",
      grupo == "ITH" & clinical_benefit == "low" ~ "ITH_low",
      grupo == "BRAF_MEK" & clinical_benefit == "high" ~ "BRAF_MEK_high",
      grupo == "BRAF_MEK" & clinical_benefit == "low" ~ "BRAF_MEK_low"
    )
  )

# Extraer nombres de gen del formato "Endogenous_SYMBOL_TRANSCRIPT"
gene_symbols <- gsub("^Endogenous_([A-Z0-9]+)_.*", "\\1", rownames(expression_matrix))
rownames(expression_matrix) <- gene_symbols

# Genes en común entre Nanostring y FPKM
genes_fpkm <- unique(fpkm_pre_sel$Symbol)
genes_expression <- rownames(expression_matrix)
genes_comunes <- intersect(genes_fpkm, genes_expression)
cat("Número de genes en común:", length(genes_comunes), "\n")

# --- Medias de expresión ---
# FPKM (PR y NR)
fpkm_pr_mean <- fpkm_pre_sel %>%
  filter(Symbol %in% genes_comunes, response_opt == "PR") %>%
  group_by(Symbol) %>%
  summarise(mean_expr = mean(log2FPKM, na.rm = TRUE)) %>%
  column_to_rownames("Symbol")

fpkm_nr_mean <- fpkm_pre_sel %>%
  filter(Symbol %in% genes_comunes, response_opt == "NR") %>%
  group_by(Symbol) %>%
  summarise(mean_expr = mean(log2FPKM, na.rm = TRUE)) %>%
  column_to_rownames("Symbol")

# ITH (high vs low)
ith_high_samples <- db_completa_log2 %>% filter(respuesta == "ITH_high") %>% pull(ID)
ith_low_samples  <- db_completa_log2 %>% filter(respuesta == "ITH_low") %>% pull(ID)

expr_ith_high <- expression_matrix[genes_comunes, ith_high_samples, drop = FALSE]
expr_ith_low  <- expression_matrix[genes_comunes, ith_low_samples, drop = FALSE]

ith_high_mean <- rowMeans(expr_ith_high, na.rm = TRUE)
ith_low_mean  <- rowMeans(expr_ith_low, na.rm = TRUE)

# --- Correlaciones ---
orden_genes <- intersect(rownames(fpkm_pr_mean), names(ith_high_mean))
pr_vector   <- fpkm_pr_mean[orden_genes, , drop = TRUE]
nr_vector   <- fpkm_nr_mean[orden_genes, , drop = TRUE]
ithh_vector <- ith_high_mean[orden_genes]
ithl_vector <- ith_low_mean[orden_genes]

cor_pr_ithh <- cor(pr_vector, ithh_vector, method = "spearman")
cor_nr_ithl <- cor(nr_vector, ithl_vector, method = "spearman")

cat("🔵 Correlación PR vs ITH_high:", round(cor_pr_ithh, 3), "\n")
cat("🔴 Correlación NR vs ITH_low:", round(cor_nr_ithl, 3), "\n")

# --- Gráficos ---
library(ggrepel)
genes_marcados <- c("CXCL10","KIT","CXCL9","CXCL1","BNIP3L","CCL14","CXCL2","WNT5B",
                    "STAT1","WNT2","GBP4","SOX2","GBP1","SPRY4","IDO1","CCL4",
                    "MAPK10","ANGPT1","HMGB1","CCL18","CCL20","OAS3","FAM124B",
                    "IFITM1","FCN1","BID","CCNA1","VCAM1")

# PR vs ITH_high
df_pr_plot <- data.frame(Gene = orden_genes,
                         FPKM_PR = pr_vector,
                         Expr_ITH_High = ithh_vector) %>%
  mutate(highlight = ifelse(Gene %in% genes_marcados, Gene, NA))

plot_ITH_high <- ggplot(df_pr_plot, aes(x = FPKM_PR, y = Expr_ITH_High)) +
  geom_point(color = "#3B4CC0", size = 2, alpha = 0.6,
             position = position_jitter(width = 0.2, height = 0.2)) +
  geom_smooth(method = "lm", se = TRUE, color = "black") +
  geom_text_repel(aes(label = highlight), na.rm = TRUE, size = 3, max.overlaps = 20) +
  labs(title = paste0("Correlación PR vs ITH_high (r = ", round(cor_pr_ithh, 2), ")"),
       x = "Expresión media log2FPKM (PR)",
       y = "Expresión media log2 (ITH high)") +
  theme_minimal()
ggsave("Resultados/PR_vs_ITH_high.png", plot = plot_ITH_high, width = 8, height = 6, dpi = 300)

# NR vs ITH_low
df_nr_plot <- data.frame(Gene = orden_genes,
                         FPKM_NR = nr_vector,
                         Expr_ITH_Low = ithl_vector) %>%
  mutate(highlight = ifelse(Gene %in% genes_marcados, Gene, NA))

plot_ITH_low <- ggplot(df_nr_plot, aes(x = FPKM_NR, y = Expr_ITH_Low)) +
  geom_point(color = "#A7C7E7", size = 2, alpha = 0.6,
             position = position_jitter(width = 0.2, height = 0.2)) +
  geom_smooth(method = "lm", se = TRUE, color = "black") +
  geom_text_repel(aes(label = highlight), na.rm = TRUE, size = 3, max.overlaps = 20) +
  labs(title = paste0("Correlación NR vs ITH_low (r = ", round(cor_nr_ithl, 2), ")"),
       x = "Expresión media log2FPKM (NR)",
       y = "Expresión media log2 (ITH low)") +
  theme_minimal()
ggsave("Resultados/NR_vs_ITH_low.png", plot = plot_ITH_low, width = 8, height = 6, dpi = 300)

```



```{r comp expr BRAF_MEK}
# --- Limpiar nombres de genes en RNA-seq ---
gene_symbols_rnaseq <- gsub("_ENSG.*", "", rownames(log2_fpkm_matrix))
rownames(log2_fpkm_matrix) <- gene_symbols_rnaseq

# --- Extraer genes comunes entre Nanostring y RNA-seq ---
genes_nanostring <- rownames(expression_matrix)
genes_rnaseq <- rownames(log2_fpkm_matrix)
genes_comunes <- intersect(genes_nanostring, genes_rnaseq)
cat("✅ Genes en común (sin filtrar):", length(genes_comunes), "\n")

# --- Filtrar genes con expresión > 0.5 en al menos una muestra de ambos datasets ---
expr_rnaseq <- log2_fpkm_matrix[genes_comunes, ]
expr_nano   <- expression_matrix[genes_comunes, ]

genes_filtrados <- genes_comunes[
  rowSums(expr_rnaseq > 0.5, na.rm = TRUE) > 0 &
  rowSums(expr_nano > 0.5, na.rm = TRUE) > 0
]
cat("🎯 Genes filtrados con expresión suficiente:", length(genes_filtrados), "\n")

# --- RNA-seq: medias por grupo (LR y SR) ---
lr_samples <- rownames(col_data)[col_data$response == "LR"]
sr_samples <- rownames(col_data)[col_data$response == "SR"]

lr_expr_mean <- rowMeans(log2_fpkm_matrix[genes_filtrados, lr_samples, drop = FALSE], na.rm = TRUE)
sr_expr_mean <- rowMeans(log2_fpkm_matrix[genes_filtrados, sr_samples, drop = FALSE], na.rm = TRUE)

# --- Nanostring: medias por grupo (BRAF_MEK high y low) ---
braf_high_samples <- db_completa_log2 %>%
  filter(respuesta == "BRAF_MEK_high") %>%
  pull(ID)

braf_low_samples <- db_completa_log2 %>%
  filter(respuesta == "BRAF_MEK_low") %>%
  pull(ID)

missing_samples <- setdiff(braf_high_samples, colnames(expression_matrix))
if (length(missing_samples) > 0) {
  cat("⚠️ Muestras de BRAF_MEK_high que NO están en la matriz de expresión:\n")
  print(missing_samples)
}

braf_high_valid <- intersect(braf_high_samples, colnames(expression_matrix))
braf_low_valid  <- intersect(braf_low_samples, colnames(expression_matrix))

braf_high_expr_mean <- rowMeans(expression_matrix[genes_filtrados, braf_high_valid, drop = FALSE], na.rm = TRUE)
braf_low_expr_mean  <- rowMeans(expression_matrix[genes_filtrados, braf_low_valid, drop = FALSE], na.rm = TRUE)

# --- Alinear vectores para correlación ---
genes_orden <- intersect(names(lr_expr_mean), names(braf_high_expr_mean))

vec_lr     <- lr_expr_mean[genes_orden]
vec_sr     <- sr_expr_mean[genes_orden]
vec_braf_h <- braf_high_expr_mean[genes_orden]
vec_braf_l <- braf_low_expr_mean[genes_orden]

# --- Correlaciones ---
cor_lr_braf_h <- cor(vec_lr, vec_braf_h, method = "spearman")
cor_sr_braf_l <- cor(vec_sr, vec_braf_l, method = "spearman")

cat("🔵 Correlación LR vs BRAF_MEK_high:", round(cor_lr_braf_h, 3), "\n")
cat("🔴 Correlación SR vs BRAF_MEK_low:", round(cor_sr_braf_l, 3), "\n")

# --- Gráficos ---
library(ggrepel)
genes_marcados <- c("HLA-DQB1","COL11A1","APH1B","IL12RB2","HEY1",
                    "IL6","IL18","GOT2","PARP12","SLC16A1","RIPK2")

# LR vs BRAF_MEK_high
df_lr_braf <- data.frame(Gene = genes_orden,
                         RNAseq_LR = vec_lr,
                         Nano_BRAF_H = vec_braf_h) %>%
  mutate(highlight = ifelse(Gene %in% genes_marcados, Gene, NA))

plot_BRAF_high <- ggplot(df_lr_braf, aes(x = RNAseq_LR, y = Nano_BRAF_H)) +
  geom_point(color = "#9370DB", size = 2, alpha = 0.6,
             position = position_jitter(width = 0.2, height = 0.2)) +
  geom_smooth(method = "lm", se = TRUE, color = "black") +
  geom_text_repel(aes(label = highlight), na.rm = TRUE, size = 3, max.overlaps = 20) +
  labs(title = paste0("LR vs BRAF_MEK_high (r = ", round(cor_lr_braf_h, 2), ")"),
       x = "Expresión media log2FPKM (LR)",
       y = "Expresión media log2 (BRAF/MEKi high)") +
  theme_minimal()
ggsave("Resultados/LR_vs_BRAF_high.png", plot = plot_BRAF_high, width = 8, height = 6, dpi = 300)

# SR vs BRAF_MEK_low
df_sr_braf <- data.frame(Gene = genes_orden,
                         RNAseq_SR = vec_sr,
                         Nano_BRAF_L = vec_braf_l) %>%
  mutate(highlight = ifelse(Gene %in% genes_marcados, Gene, NA))

plot_BRAF_low <- ggplot(df_sr_braf, aes(x = RNAseq_SR, y = Nano_BRAF_L)) +
  geom_point(color = "#CE93D8", size = 2, alpha = 0.6,
             position = position_jitter(width = 0.2, height = 0.2)) +
  geom_smooth(method = "lm", se = TRUE, color = "black") +
  geom_text_repel(aes(label = highlight), na.rm = TRUE, size = 3, max.overlaps = 20) +
  labs(title = paste0("SR vs BRAF_MEK_low (r = ", round(cor_sr_braf_l, 2), ")"),
       x = "Expresión media log2FPKM (SR)",
       y = "Expresión media log2 (BRAF/MEKi low)") +
  theme_minimal()
ggsave("Resultados/SR_vs_BRAF_low.png", plot = plot_BRAF_low, width = 8, height = 6, dpi = 300)



```








