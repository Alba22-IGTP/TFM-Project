---
title: "log2+Heatmap after SF+PCA"
author: "xxx"
date: "2025-04-15"
output: html_document
---


```{r setup, include=FALSE}
# ===========================
# Cargar librerías necesarias
# ===========================
library(readr)
library(pheatmap)
library(dplyr)
library(RColorBrewer)
library(ggplot2)
library(reshape2)
library(tibble)
library(patchwork)
library(FactoMineR)
library(factoextra)
library(tidyr)

# ===========================
# Definir rutas genéricas
# ===========================
input_dir <- "Datos_finales"              # Carpeta con los datos de entrada
output_dir <- "Results_Log2_Heatmap_PCA" # Carpeta donde se guardarán los resultados

# Crear carpeta de salida si no existe
if(!dir.exists(output_dir)) dir.create(output_dir)

# ===========================
# Archivos de entrada necesarios
# ===========================
# 1. Matriz de expresión normalizada
expr_file <- file.path(input_dir, "final_normalized_matrix.csv")

# 2. Base de datos clínica
clinic_file <- file.path(input_dir, "clin_data.csv")

```

```{r preparación de datos}
# Cargar datos
gene_expr <- read_csv(expr_file)
clinic_db <- read_delim(clinic_file, delim = ";", escape_double = FALSE, trim_ws = TRUE)

# ===========================
# Transponer y limpiar la matriz
# ===========================
gene_expr_t <- as.data.frame(t(gene_expr), stringsAsFactors = FALSE)
colnames(gene_expr_t) <- gene_expr_t[1, ]
gene_expr_t <- gene_expr_t[-1, ]
gene_expr_t[] <- lapply(gene_expr_t, function(x) as.numeric(as.character(x)))

# Aplicar log2 pseudocounts (evitar -Inf)
min_no_zero <- min(gene_expr_t[gene_expr_t > 0], na.rm = TRUE)
gene_expr_t_log2 <- log2(gene_expr_t + (min_no_zero/2))
gene_expr_t_log2 <- tibble::rownames_to_column(gene_expr_t_log2, var = "ID")

# ===========================
# Ordenar y combinar con base clínica
# ===========================
# Se asume que clinic_db$ID coincide con nombres de muestras
clinic_db_ordenada <- clinic_db[order(match(clinic_db$ID, gene_expr_t_log2$ID)), ]
db_completa_log2 <- merge(clinic_db_ordenada, gene_expr_t_log2, by = "ID")

# Guardar tabla combinada
write.csv(db_completa_log2, file = file.path(output_dir, "db_completa_log2.csv"), row.names = FALSE)

```


```{r Heatmap log2-zscored}
# Crear matriz de expresión de genes endógenos
expr_matrix <- db_completa_log2 %>%
  dplyr::select(ID, starts_with("Endogenous_")) %>%
  tibble::column_to_rownames(var = "ID") %>%
  as.matrix()

# Preparar anotaciones clínicas
annotation_df <- data.frame(
  row.names = db_completa_log2$ID,
  Treatment = factor(db_completa_log2$grupo),
  Clinical_Benefit = factor(db_completa_log2$clinical_benefit)
)

# Definir colores
annotation_colors <- list(
  Treatment = c(BRAF_MEK = "#9A32CD", ITH = "#00CED1"),
  Clinical_Benefit = c(high = "#FF69B4", low = "#98FB98")
)

# Generar y guardar heatmap
pdf(file.path(output_dir, "Endogenous_Genes_Heatmap.pdf"), width = 15, height = 10)
pheatmap(expr_matrix,
         annotation_row = annotation_df,
         annotation_colors = annotation_colors,
         color = colorRampPalette(rev(brewer.pal(11, "RdBu")))(100),
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         scale = "row",
         show_rownames = TRUE,
         show_colnames = FALSE,
         fontsize_row = 6,
         main = "log2 Endogenous Gene Expression (Z-score)",
         border_color = NA)
dev.off()

```


```{r PCA}
# Matriz de genes endógenos
endogenous_cols <- grep("^Endogenous", names(db_completa_log2), value = TRUE)
expresion_genica <- db_completa_log2[, endogenous_cols] %>% mutate_all(as.numeric)

# Reemplazar NAs por mediana
expresion_genica[] <- lapply(expresion_genica, function(x) ifelse(is.na(x), median(x, na.rm = TRUE), x))

# Escalado y PCA
expresion_normalizada <- scale(expresion_genica)
rownames(expresion_normalizada) <- db_completa_log2$ID
pca.results <- PCA(expresion_normalizada, graph = FALSE, ncp = 10)

# Varianza explicada
varianza_explicada <- pca.results$eig[,2] / 100
varianza_table <- data.frame(PC=paste0("PC", 1:length(varianza_explicada)),
                             Variance = round(varianza_explicada,3),
                             Cumulative = round(cumsum(varianza_explicada),3))
print(varianza_table)

# PCA plot
pca_data <- as.data.frame(pca.results$ind$coord[,1:2])
pca_data <- pca_data %>%
  mutate(
    clinical_benefit = db_completa_log2$clinical_benefit,
    grupo = db_completa_log2$grupo,
    group = factor(paste(clinical_benefit, grupo, sep="_"),
                  levels=c("high_BRAF_MEK","low_BRAF_MEK","high_ITH","low_ITH"))
  )

color_palette <- c("high_ITH"="#C51B8A","low_ITH"="#FCC5C0",
                   "high_BRAF_MEK"="#08306B","low_BRAF_MEK"="#9E9AC8")

pca_plot <- ggplot(pca_data, aes(x=PC1, y=PC2, color=group)) +
  geom_point(size=4, alpha=0.8) +
  scale_color_manual(values=color_palette) +
  labs(title="PCA of Gene Expression Profiles",
       x=paste0("PC1 (", round(varianza_explicada[1]*100,1), "%)"),
       y=paste0("PC2 (", round(varianza_explicada[2]*100,1), "%)")) +
  theme_minimal() +
  theme(plot.title=element_text(hjust=0.5, face="bold", size=14),
        legend.position="bottom")

# Guardar plot PCA
ggsave(file.path(output_dir, "PCA_plot.png"), pca_plot, width=10, height=8, dpi=300)

```



