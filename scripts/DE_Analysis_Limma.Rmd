---
title: "Differential Expression Analysis with Limma"
author: "Alba de la Puente Noël"
date: "2025-04-02"
output: html_document
---


**Preparamos datos**
```{r setup, include=FALSE}

# Cargar las librerías necesarias
library(tidyverse)
library(limma)
library(EnhancedVolcano)
library(clusterProfiler)
library(org.Hs.eg.db)
library(ggplot2)
library(pheatmap)

# Instalar y cargar librería here si no la tienes
if(!require(here)) install.packages("here")
library(here)

# Cargar el archivo CSV automáticamente desde la carpeta del proyecto
db_completa_log2 <- read.csv(here("db_completa_log2.csv"))

# Comprobar que se cargó
head(db_completa_log2)

# Carpeta de salida
output_dir <- "Resultados"
if(!dir.exists(output_dir)) dir.create(output_dir)

# Ejemplo de guardar volcano plot
save_volcano <- function(plot, filename, width = 6, height = 6) {
  ggsave(
    filename = file.path(output_dir, filename),
    plot = plot,
    device = "png",
    width = width,
    height = height,
    dpi = 300,
    units = "in"
  )
}

# Guardar tabla de genes significativos
write_csv(significant_genes, file.path(output_dir, "genes_significativos_nonresrict.csv"))

```

```{r Matriz para DE Analysis}
# 1. Extraer matriz de expresión
expression_matrix <- db_completa_log2 %>%
  # Seleccionar columnas manteniendo IDs
  dplyr::select(ID, starts_with("Endogenous_")) %>%
  # Convertir a matriz (sin problemas con spec_tbl_df)
  as.data.frame() %>% 
  column_to_rownames("ID") %>% 
  t() %>%  # Transponer para genes x muestras
  as.matrix()

# Verificar estructura
print(dim(expression_matrix)) # [genes, muestras]
print(expression_matrix[1:5, 1:5]) # Visualizar parte


# 2. Preparar metadatos 
metadata <- db_completa_log2 %>%
  dplyr::select(ID, grupo, clinical_benefit, sexo, edad_diagnostico) %>%
  filter(ID %in% colnames(expression_matrix)) %>%
  mutate(
    grupo = factor(grupo, levels = c("BRAF_MEK", "ITH")),
    clinical_benefit = factor(clinical_benefit, levels = c("low", "high"))
  ) %>%
  column_to_rownames("ID")
 
dim(metadata)
dim(expression_matrix)

# Transpose expression_log (samples as rows, genes as columns)
expression_log_t <- t(expression_matrix)  

# Now dimensions should match:
dim(metadata)      
dim(expression_log_t)    

# Combine them
db_final <- cbind(metadata, expression_log_t)  
db_final <- db_final %>% 
  tibble::rownames_to_column(var = "ID")

View(db_final)


# Asegurar que los grupos tengan la referencia correcta
db_final$grupo <- factor(db_final$grupo, levels = c("BRAF_MEK", "ITH"))  
db_final$clinical_benefit <- factor(db_final$clinical_benefit, levels = c("low", "high"))  

# Verificar niveles
levels(db_final$grupo)        
levels(db_final$clinical_benefit)

# Verificar dimensiones de la matriz de expresión
dim(expression_matrix)


```


```{r limma1}
library(tidyverse)
library(limma)
library(EnhancedVolcano)
library(pheatmap)
library(here)
library(readr)

# --- Análisis global ---
# --- Grupo ---
design_grupo <- model.matrix(~0 + grupo, data = metadata_ordered)
colnames(design_grupo) <- levels(metadata_ordered$grupo)
contrast_grupo <- makeContrasts(BRAF_MEK_vs_ITH = BRAF_MEK - ITH, levels = design_grupo)
fit_grupo <- lmFit(expression_matrix, design_grupo) %>%
  contrasts.fit(contrast_grupo) %>%
  eBayes()

# --- Clinical benefit ---
design_benefit <- model.matrix(~0 + clinical_benefit, data = metadata_ordered)
colnames(design_benefit) <- levels(metadata_ordered$clinical_benefit)
contrast_benefit <- makeContrasts(High_vs_Low = high - low, levels = design_benefit)
fit_benefit <- lmFit(expression_matrix, design_benefit) %>%
  contrasts.fit(contrast_benefit) %>%
  eBayes()


# --- Análisis por subgrupos ---
analyze_subgroup <- function(grupo_name, expression_matrix, metadata) {
  samples_sub <- metadata %>% filter(grupo == grupo_name)
  expr_sub <- expression_matrix[rownames(expression_matrix) %in% samples_sub$ID, , drop = FALSE]
  design_sub <- model.matrix(~clinical_benefit, data = samples_sub)
  lmFit(expr_sub, design_sub) %>% eBayes()
}

fit_braf <- analyze_subgroup("BRAF_MEK", expression_matrix, metadata_ordered)
fit_ith  <- analyze_subgroup("ITH", expression_matrix, metadata_ordered)



# --- Comparaciones high/low por grupo ---
# High benefit BRAF_MEK vs ITH
high_samples <- metadata_ordered %>% filter(clinical_benefit=="high", grupo %in% c("BRAF_MEK","ITH"))
expr_high <- expression_matrix[rownames(expression_matrix) %in% high_samples$ID, , drop=FALSE]
design_high <- model.matrix(~0 + grupo, data=high_samples)
colnames(design_high) <- levels(high_samples$grupo)
contrast_high <- makeContrasts(BRAF_MEK_vs_ITH_high = BRAF_MEK - ITH, levels=design_high)
fit_high <- lmFit(expr_high, design_high) %>% contrasts.fit(contrast_high) %>% eBayes()

# Low benefit BRAF_MEK vs ITH
low_samples <- metadata_ordered %>% filter(clinical_benefit=="low", grupo %in% c("BRAF_MEK","ITH"))
expr_low <- expression_matrix[rownames(expression_matrix) %in% low_samples$ID, , drop=FALSE]
design_low <- model.matrix(~0 + grupo, data=low_samples)
colnames(design_low) <- levels(low_samples$grupo)
contrast_low <- makeContrasts(BRAF_MEK_vs_ITH_low = BRAF_MEK - ITH, levels=design_low)
fit_low <- lmFit(expr_low, design_low) %>% contrasts.fit(contrast_low) %>% eBayes()


# --- Función para extraer resultados ---
extract_results <- function(fit, contrast_name) {
  topTable(fit, number=Inf, adjust.method="BH", sort.by="none") %>%
    as_tibble(rownames="gene") %>%
    mutate(
      contrast = contrast_name,
      significance = ifelse(P.Value < 0.05 & abs(logFC) > 1, "significant","not significant"),
      gene_clean = str_extract(gene,"(?<=Endogenous_).*")
    )
}

final_results <- bind_rows(
  extract_results(fit_grupo, "BRAF_MEK_vs_ITH"),
  extract_results(fit_benefit, "High_vs_Low_global"),
  extract_results(fit_braf, "BRAF_MEK_High_vs_Low"),
  extract_results(fit_ith, "ITH_High_vs_Low"),
  extract_results(fit_high, "BRAF_MEK_High_vs_ITH_High"),
  extract_results(fit_low, "BRAF_MEK_Low_vs_ITH_Low")
) %>% arrange(P.Value)

# Guardar CSV
write_csv(final_results, here("Resultados", "resultados_diferenciales_completos.csv"))


# --- Volcano plot  ---
save_volcano <- function(plot, filename) {
  ggsave(here("Resultados", filename), plot=plot, device="png", width=6, height=6, dpi=300)
}

plot_volcano_with_counts <- function(result_df, label_vector, contrast_name,
                                     logfc_cutoff=1, pval_cutoff=0.05,
                                     xlim_vals=c(-4,4), ylim_vals=c(0,4)) {
  genes_up <- result_df %>% filter(logFC>logfc_cutoff, P.Value<pval_cutoff) %>% nrow()
  genes_down <- result_df %>% filter(logFC< -logfc_cutoff, P.Value<pval_cutoff) %>% nrow()
  genes_total <- result_df %>% filter(abs(logFC)>logfc_cutoff, P.Value<pval_cutoff) %>% nrow()
  title_text <- paste0(contrast_name, "\nUp:",genes_up," | Down:",genes_down," | Total:",genes_total)
  EnhancedVolcano(
    result_df,
    lab = label_vector,
    x = 'logFC',
    y = 'P.Value',
    pCutoff = pval_cutoff,
    FCcutoff = logfc_cutoff,
    title = title_text,
    subtitle = 'Differential Analysis',
    legendLabels=c('No Sig','Log2FC','P-Value','P & Log2FC'),
    colAlpha=0.7,
    xlim=xlim_vals,
    ylim=ylim_vals
  )
}

# Seleccionar subconjuntos
subsets <- list(
  "BRAF_MEK_High_vs_ITH_High" = "High BRAF/MEKi vs ITH",
  "BRAF_MEK_High_vs_Low" = "BRAF/MEKi High vs Low",
  "ITH_High_vs_Low" = "ITH High vs Low",
  "BRAF_MEK_Low_vs_ITH_Low" = "Low BRAF/MEKi vs ITH"
)

for(name in names(subsets)) {
  df <- final_results %>% filter(contrast==name)
  volcano <- plot_volcano_with_counts(df, df$gene_clean, subsets[[name]])
  print(volcano)
  save_volcano(volcano, paste0(name,".png"))
}

```



**Tablas**
```{r Tablas}
```{r Tablas, message=FALSE, warning=FALSE}
library(dplyr)
library(readr)
library(here)

# Filtrar genes significativos según contraste y criterios
significant_genes <- final_results %>%
  dplyr::filter(
    (contrast == "BRAF_MEK_High_vs_ITH_High" & P.Value < 0.05 & abs(logFC) > log2(0.5)) |
    (contrast == "BRAF_MEK_High_vs_Low" & P.Value < 0.05 & abs(logFC) > log2(0.5)) |
    (contrast == "ITH_High_vs_Low" & P.Value < 0.05 & abs(logFC) > log2(0.5)) |
    (contrast == "BRAF_MEK_Low_vs_ITH_Low" & P.Value < 0.05 & abs(logFC) > log2(0.5))
  ) %>%
  dplyr::select(contrast, gene_clean, logFC, P.Value, adj.P.Val) %>%
  dplyr::arrange(contrast, desc(abs(logFC))) %>%
  dplyr::mutate(
    logFC = round(logFC, 2),
    P.Value = signif(P.Value, 3),
    adj.P.Val = signif(adj.P.Val, 3),
    Contrast = dplyr::case_when(
      contrast == "BRAF_MEK_High_vs_ITH_High" ~ "BRAF/MEK High vs ITH High",
      contrast == "BRAF_MEK_High_vs_Low" ~ "BRAF/MEK High vs Low",
      contrast == "ITH_High_vs_Low" ~ "ITH High vs Low",
      contrast == "BRAF_MEK_High_vs_ITH_Low" ~ "BRAF/MEK High vs ITH Low",
      TRUE ~ contrast
    )
  ) %>%
  dplyr::rename(
    Gene = gene_clean,
    `Log2 Fold Change` = logFC,
    `P-value` = P.Value,
    `Adjusted P-value` = adj.P.Val
  ) %>%
  dplyr::select(Contrast, Gene, `Log2 Fold Change`, `P-value`, `Adjusted P-value`)

# Mostrar tabla
significant_genes

# Exportar a CSV en la carpeta Resultados/ (ruta relativa)
write_csv(significant_genes, here("Resultados", "genes_significativos_nonrestrict.csv"))


```


```{r heatmap}
library(pheatmap)
library(dplyr)

# --- Paso 1: Preparar matriz con genes limpios ---
# --- Paso 1: Extraer genes significativos para BRAF/MEK High vs ITH High ---
genes_braf_ith <- significant_genes %>%
  filter(Contrast == "BRAF/MEK High vs ITH High") %>%
  pull(Gene)


# Quitar prefijo "Endogenous_"
genes_expr_clean <- gsub("^Endogenous_", "", rownames(expression_matrix))

# Extraer solo el símbolo del gen antes del "_"
genes_expr_simple <- sub("_.*", "", genes_expr_clean)

# Índices de genes presentes en la lista significativa
indices_genes <- which(genes_expr_simple %in% genes_braf_ith)

# Submatriz expresión
expr_subset <- expression_matrix[indices_genes, , drop = FALSE]

# Renombrar filas a símbolos limpios
rownames(expr_subset) <- genes_expr_simple[indices_genes]

# --- Paso 2: Preparar anotación para columnas (muestras) ---

# metadata debe tener filas ordenadas igual que las columnas de expr_subset
# Asegúrate que metadata esté en el mismo orden que colnames(expr_subset)

metadata_ordered <- metadata[colnames(expr_subset), , drop=FALSE]

annotation_col <- data.frame(
  Grupo = metadata_ordered$grupo,
  ClinicalBenefit = metadata_ordered$clinical_benefit
)
rownames(annotation_col) <- rownames(metadata_ordered)

# --- Paso 3: Generar heatmap y guardar en PNG ---

png("Resultados/heatmap_BRAF_MEK_vs_ITH.png", width = 1000, height = 800)
pheatmap(expr_subset,
         annotation_col = annotation_col,
         scale = "row",
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         show_rownames = TRUE,
         show_colnames = FALSE,
         fontsize_row = 8,
         main = "Heatmap Genes BRAF/MEK High vs ITH High")
dev.off()


```


```{r PCA}

library(dplyr)
library(ggplot2)
library(ggrepel)

expr_for_pca <- t(expr_subset)

# Comprobar coincidencia de muestras
if(!all(rownames(expr_for_pca) %in% rownames(metadata))){
  stop("Hay muestras en la expresión que no están en el metadata")
}

metadata_ordered <- metadata[rownames(expr_for_pca), ]

pca_res <- prcomp(expr_for_pca, center = TRUE, scale. = TRUE)
var_explained <- pca_res$sdev^2 / sum(pca_res$sdev^2)
pc1_var <- round(var_explained[1] * 100, 1)
pc2_var <- round(var_explained[2] * 100, 1)

pca_df <- data.frame(
  Sample = rownames(pca_res$x),
  PC1 = pca_res$x[,1],
  PC2 = pca_res$x[,2],
  Grupo = metadata_ordered$grupo,
  Beneficio = metadata_ordered$clinical_benefit
)

pca_df <- pca_df %>% mutate(Group = paste0(Grupo, "_", Beneficio))

group_colors <- c(
  "BRAF_MEK_high" = "#9A32CD",
  "BRAF_MEK_low"  = "lavender",
  "ITH_high"      = "#00CED1",
  "ITH_low"       = "lightblue"
)

p <- ggplot(pca_df, aes(x = PC1, y = PC2, color = Group)) +
  geom_point(size = 3) +
  geom_text_repel(aes(label = Sample), size = 3, max.overlaps = 10) +
  scale_color_manual(values = group_colors) +
  labs(
    title = "PCA Genes de Interés",
    x = paste0("PC1 (", pc1_var, "% varianza)"),
    y = paste0("PC2 (", pc2_var, "% varianza)"),
    color = "Grupo"
  ) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "right",
        plot.title = element_text(hjust = 0.5))

ggsave("Resultados/PCA_Genes_Interés.png", plot = p, width = 8, height = 6, dpi = 300)

write.csv(
  significant_genes %>% filter(Contrast == "BRAF/MEK High vs ITH High"),
  "Resultados/tabla_genes_significativos_BRAF_MEK_vs_ITH.csv",
  row.names = FALSE
)

```


```{r efectos sexo y edad}
library(dplyr)
library(ggplot2)
library(limma)
library(DT)
library(stringr)

# --- Filtrar genes significativos según contrastes previos ---
sig_genes <- final_results %>%
  filter(
    (contrast == "BRAF_MEK_High_vs_ITH_High" & P.Value < 0.05 & abs(logFC) > log2(1.5)) |
    (contrast == "BRAF_MEK_High_vs_Low" & P.Value < 0.05 & abs(logFC) > log2(1)) |
    (contrast == "ITH_High_vs_Low" & P.Value < 0.05 & abs(logFC) > log2(2))
  ) %>%
  pull(gene) %>%
  unique()

# --- Matriz de expresión filtrada ---
expr_sig <- expression_matrix[rownames(expression_matrix) %in% sig_genes, ]

# --- Modelo lineal: efectos de sexo y edad ---
design <- model.matrix(~ sexo + edad_diagnostico, data = metadata_ordered)
fit <- lmFit(expr_sig, design) %>% eBayes()

# --- Resultados SEXO ---
results_sexo <- topTable(fit, coef = "sexoM", number = Inf) %>%
  as_tibble(rownames = "gene") %>%
  mutate(
    gene_clean = str_extract(gene, "(?<=Endogenous_).*(?=_NM)"),
    Direction = ifelse(logFC > 0, "Mayor en Mujeres (M)", "Mayor en Hombres (H)")
  )

# --- Resultados EDAD ---
results_edad <- topTable(fit, coef = "edad_diagnostico", number = Inf) %>%
  as_tibble(rownames = "gene") %>%
  mutate(gene_clean = str_extract(gene, "(?<=Endogenous_).*(?=_NM)"))

# --- Genes significativos p<0.05 ---
genes_sexo_sig <- results_sexo %>% filter(P.Value < 0.05) %>% pull(gene_clean)
genes_edad_sig <- results_edad %>% filter(P.Value < 0.05) %>% pull(gene_clean)

# --- Tablas interactivas TOP 10 ---
results_sexo %>%
  arrange(P.Value) %>%
  head(10) %>%
  datatable(options = list(pageLength = 5), rownames = FALSE) %>%
  formatSignif(columns = c("logFC", "P.Value", "adj.P.Val"), digits = 3)

results_edad %>%
  arrange(P.Value) %>%
  head(10) %>%
  datatable(options = list(pageLength = 5), rownames = FALSE) %>%
  formatSignif(columns = c("logFC", "P.Value", "adj.P.Val"), digits = 3)

# --- Histograma p-valores SEXO ---
plot_sexo <- ggplot(results_sexo, aes(x = P.Value)) +
  geom_histogram(bins = 30, fill = "palevioletred", color = "white") +
  geom_vline(xintercept = 0.05, linetype = "dashed", color = "red") +
  labs(
    title = "Distribución de p-valores para efecto de sexo",
    x = "p-valor", y = "Número de genes"
  ) +
  theme_minimal()

# --- Histograma p-valores EDAD ---
plot_edad <- ggplot(results_edad, aes(x = P.Value)) +
  geom_histogram(bins = 30, fill = "slateblue2", color = "white") +
  geom_vline(xintercept = 0.05, linetype = "dashed", color = "red") +
  labs(
    title = "Distribución de p-valores para efecto de edad",
    x = "p-valor", y = "Número de genes"
  ) +
  theme_minimal()

# --- Guardar histogramas en carpeta Resultados ---
ggsave("Resultados/histograma_pvalores_sexo.png", plot_sexo, width = 7, height = 5, dpi = 300)
ggsave("Resultados/histograma_pvalores_edad.png", plot_edad, width = 7, height = 5, dpi = 300)

# --- Boxplot para el gen más significativo por sexo ---
if(nrow(results_sexo) > 0) {
  top_gene <- results_sexo$gene[1]
  gene_name <- results_sexo$gene_clean[1]
  df_plot <- data.frame(
    Expression = expr_sig[top_gene, ],
    Sex = metadata_ordered$sexo,
    Grupo = metadata_ordered$grupo
  )
  ggplot(df_plot, aes(x = Sex, y = Expression, fill = Sex)) +
    geom_boxplot() +
    geom_jitter(width = 0.1, aes(color = Grupo), size = 3) +
    scale_fill_manual(values = c("H" = "#4E79A7", "M" = "#F28E2B")) +
    labs(title = paste("Expresión de", gene_name, "por sexo"),
         y = "log2(Expresión)") +
    theme_minimal()
}

# --- Scatter y boxplot para edad ---
if(nrow(results_edad) > 0) {
  top_gene_edad <- results_edad$gene[1]
  gene_name_edad <- results_edad$gene_clean[1]
  df_edad <- data.frame(
    Expression = expr_sig[top_gene_edad, ],
    Edad = metadata_ordered$edad_diagnostico,
    Sexo = metadata_ordered$sexo,
    Grupo = metadata_ordered$grupo
  )
  
  # Scatter con regresión por grupo
  ggplot(df_edad, aes(x = Edad, y = Expression, color = Grupo, shape = Sexo)) +
    geom_point(size = 3) +
    geom_smooth(method = "lm", se = FALSE, aes(group = Grupo)) +
    scale_color_manual(values = c("BRAF_MEK" = "#E41A1C", "ITH" = "#377EB8")) +
    scale_shape_manual(values = c("H" = 16, "M" = 17)) +
    labs(title = paste("Expresión de", gene_name_edad, "vs edad"),
         x = "Edad al diagnóstico (años)", y = "log2(Expresión)") +
    theme_minimal()
  
  # Boxplot por grupo de edad (mediana)
  df_edad_groups <- df_edad %>% 
    mutate(Grupo_Edad = ifelse(Edad > median(Edad), "Mayores", "Jóvenes"),
           Grupo_Edad = factor(Grupo_Edad, levels = c("Jóvenes", "Mayores")))
  
  ggplot(df_edad_groups, aes(x = Grupo_Edad, y = Expression, fill = Grupo_Edad)) +
    geom_boxplot(alpha = 0.7) +
    geom_jitter(aes(color = Grupo), width = 0.1, size = 2.5) +
    scale_fill_manual(values = c("Jóvenes" = "#FFD700", "Mayores" = "#CD7F32")) +
    scale_color_manual(values = c("BRAF_MEK" = "#E41A1C", "ITH" = "#377EB8")) +
    labs(title = paste("Expresión de", gene_name_edad, "por grupo de edad"),
         x = "", y = "log2(Expresión)") +
    theme_minimal()
}

```


```{r boxplots biomarcadores}
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggpubr)
library(gridExtra)

# --- Filtrar muestra GEM12 ---
db_completa_log2 <- db_completa_log2 %>% filter(ID != "GEM12")

# --- Preparar datos para plot ---
plot_data <- db_completa_log2 %>%
  dplyr::select(ID, grupo, clinical_benefit) %>%
  cbind(., expr_matrix_filtered[rownames(expr_matrix_filtered) %in% db_completa_log2$ID, cols_filtradas]) %>%
  pivot_longer(
    cols = cols_filtradas,
    names_to = "Gene",
    values_to = "Expression"
  ) %>%
  mutate(
    Gene = acortar_genes(Gene),
    Group = paste(grupo, clinical_benefit, sep = "_")
  )

# --- Resultados de limma para p-valor y logFC ---
resultados_limma_plot <- final_results %>%
  dplyr::select(gene_clean, P.Value, adj.P.Val, logFC, contrast) %>%
  rename(
    Gene = gene_clean,
    pval = P.Value,
    padj = adj.P.Val
  )

# --- Definir comparaciones ---
comparisons <- list(
  c("ITH_high", "ITH_low"),
  c("BRAF_MEK_high", "BRAF_MEK_low"),
  c("ITH_high", "BRAF_MEK_high"),
  c("ITH_low", "BRAF_MEK_low")
)

# --- Crear boxplot por gen ---
create_gene_boxplot <- function(gene) {
  df <- plot_data %>% filter(Gene == gene)
  ggplot(df, aes(x = Group, y = Expression, fill = Group)) +
    geom_boxplot(outlier.shape = NA, alpha = 0.7) +
    geom_jitter(width = 0.2, size = 1.5) +
    scale_fill_manual(values = ann_colors$Group) +
    stat_compare_means(
      comparisons = comparisons,
      method = "wilcox.test",
      label = "p.signif",
      hide.ns = TRUE
    ) +
    labs(
      title = paste("Expression of", gene),
      x = "",
      y = "Expression (log2)"
    ) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "none"
    )
}

# --- Crear y guardar plots ---
if (!dir.exists("boxplots")) dir.create("boxplots")

boxplot_list <- lapply(unique(plot_data$Gene), create_gene_boxplot)

for (i in seq_along(boxplot_list)) {
  gene_name <- unique(plot_data$Gene)[i]
  ggsave(
    filename = paste0("boxplots/", gene_name, "_expression.png"),
    plot = boxplot_list[[i]],
    width = 6,
    height = 5,
    dpi = 300
  )
}

# --- Crear plot combinado ---
combined_plot <- ggarrange(plotlist = boxplot_list, ncol = 4, nrow = 5, common.legend = TRUE)

# Guardar como PNG
png("boxplots/combined_expression_plot.png", width = 15, height = 20, units = "in", res = 300)
grid::grid.draw(combined_plot)
dev.off()


```














