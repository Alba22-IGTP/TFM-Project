---
title: "Características clínicas"
author: "xxx"
date: "2025-05-08"
output: html_document
---


```{r setup}
# Librerías necesarias
library(tidyverse)
library(limma)
library(EnhancedVolcano)
library(clusterProfiler)
library(org.Hs.eg.db)
library(ggplot2)
library(pheatmap)
library(gtsummary)
library(gt)
library(survival)
library(survminer)

# Crear carpetas de salida
if(!dir.exists("Resultados")) dir.create("Resultados")

# Cargar base de datos log2
db_completa_log2 <- read_csv("Datos_finales/db_completa_log2.csv")
db_completa_log2 <- as.data.frame(db_completa_log2)

# Convertir fechas
fechas <- c("fecha_diagnostico", "progresion_date", "exitus_or_last_control", "inicio_first_line")
db_completa_log2[fechas] <- lapply(db_completa_log2[fechas], function(x) as.Date(x, format="%d/%m/%Y"))

# Calcular TLP y SG (meses)
TLP <- rep(NA, nrow(db_completa_log2))
SG  <- rep(NA, nrow(db_completa_log2))
valid_pfs <- !is.na(db_completa_log2$inicio_first_line) & !is.na(db_completa_log2$progresion_date)
TLP[valid_pfs] <- round(as.numeric(db_completa_log2$progresion_date[valid_pfs]-db_completa_log2$inicio_first_line[valid_pfs])/30.44,1)
valid_os <- !is.na(db_completa_log2$fecha_diagnostico) & !is.na(db_completa_log2$exitus_or_last_control)
SG[valid_os] <- round(as.numeric(db_completa_log2$exitus_or_last_control[valid_os]-db_completa_log2$fecha_diagnostico[valid_os])/30.44,1)

db_completa_log2$TLP <- TLP
db_completa_log2$SG  <- SG

# Crear matriz de expresión
expression_matrix <- db_completa_log2 %>%
  select(ID, starts_with("Endogenous_")) %>%
  column_to_rownames("ID") %>%
  as.matrix()

# Eliminar muestras opcionales (ejemplo sample12)
expression_matrix <- expression_matrix[, !colnames(expression_matrix) %in% "sample12"]

# Preparar metadata
metadata <- db_completa_log2 %>%
  select(ID, grupo, clinical_benefit, sexo, edad_diagnostico, estado_actual_binary, LDH_basal,
         Breslow, Clark, Ulceracion, TLP, SG) %>%
  filter(ID %in% colnames(expression_matrix)) %>%
  mutate(grupo = factor(grupo, levels=c("BRAF_MEK","ITH")),
         clinical_benefit = factor(clinical_benefit, levels=c("low","high"))) %>%
  column_to_rownames("ID")

# Transponer expresión (samples x genes)
expression_log_t <- t(expression_matrix)

# Combinar metadata + expresión
db_final <- cbind(metadata, expression_log_t) %>%
  tibble::rownames_to_column(var="ID")



```

```{r Caracteristicas_clinicas}
# Preparar tabla de características clínicas
db_clin <- db_final %>%
  select(-starts_with("Endogenous_")) %>%
  mutate(
    across(where(is.character), ~na_if(., "Unknown")),
    sexo = factor(sexo, levels=c("H","M"), labels=c("Hombre","Mujer")),
    edad_cat = factor(ifelse(edad_diagnostico<60,"<60","≥60"),levels=c("<60","≥60")),
    grupo = factor(grupo, levels=c("BRAF_MEK","ITH"),
                   labels=c("Terapia dirigida (BRAF/MEK)","Inmunoterapia")),
    clinical_benefit = factor(clinical_benefit, levels=c("low","high"), labels=c("Bajo","Alto")),
    LDH_cat = factor(case_when(LDH_basal<300~"<300 U/I", LDH_basal>=300~"≥300 U/I", TRUE~"N/V")),
    ulceracion = factor(Ulceracion, levels=c("SI","NO"), labels=c("Sí","No")),
    Breslow_cat = factor(case_when(Breslow>=1 & Breslow<=4 ~ "1-4 mm", Breslow>4 ~ ">4 mm", TRUE~"N/V")),
    TLP = ifelse(is.na(TLP), NA_real_, TLP),
    SG  = ifelse(is.na(SG), NA_real_, SG)
  )

# Tabla resumen con gtsummary
tabla_final <- db_clin %>%
  tbl_summary(
    by = grupo,
    include=c(sexo, edad_cat, estado_actual_binary, clinical_benefit, LDH_cat,
              Breslow_cat, Clark, ulceracion, TLP, SG)
  ) %>%
  add_p() %>%
  bold_labels()

# Guardar como PNG
tabla_gt <- as_gt(tabla_final)
gtsave(tabla_gt, file = "Resultados/tabla_caracteristicas.png", vwidth=1500,vheight=1000,zoom=2)

```


```{r Kaplan-Meier}
# Función genérica para curvas Kaplan-Meier
crear_curva <- function(db, tiempo, grupo_col, nombre_archivo, palette=c("purple","#2E9FDF"), xlim=NULL){
  curva <- ggsurvplot(
    survfit(Surv(get(tiempo), !is.na(get(tiempo))) ~ get(grupo_col), 
            data = db),
    palette = palette,
    conf.int=TRUE, conf.int.alpha=0.1,
    risk.table=TRUE, risk.table.y.text=FALSE,
    legend.title="Grupo",
    title=paste0("Curva de ", tiempo),
    xlab="Meses", ylab="Probabilidad",
    tables.theme = theme_cleantable(),
    ggtheme = theme_minimal() + theme(plot.title=element_text(face="bold",hjust=0.5))
  )
  ggsave(paste0("Resultados/",nombre_archivo), plot=print(curva), width=10, height=7, dpi=300)
  return(curva)
}

# Curvas principales
curva_SG  <- crear_curva(db_final, "SG", "grupo", "curva_SG_mejorada.png")
curva_TLP <- crear_curva(db_final, "TLP", "grupo", "curva_TLP_mejorada.png")

```






